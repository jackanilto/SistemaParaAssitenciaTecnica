unit UClasse.Entity.Caixa;

interface

uses
  FireDAC.Comp.Client, UDados.Conexao, System.SysUtils, Vcl.StdCtrls;

type
  TEntityCaixa = class

    private

    FQuery:TFDQuery;

    var
      FUltimaData:TDate;
      FOperacaoASerFeita:string;

    public

    function verificarSituacaoCaixa:string;
    function calcularParcelasOS(value:TEdit):Currency;
    function calcularParcelasVendas(value:TEdit):Currency;
    function calcularRetiradas(value:TEdit):Currency;
    function calcularEstornos(value:TEdit):Currency;
    function ultimoValorDoCaixa(value:TEdit):Currency;

    constructor create;
    destructor destroy; override;

  end;

implementation

{ TEntityCaixa }

function TEntityCaixa.calcularEstornos(value: TEdit): Currency;
var
   TQuery:TFDQuery;
   total:Currency;
begin

  result := 0;

  TQuery := TFDQuery.Create(nil);
  TQuery.Connection := DataModule1.Conexao;

  TQuery.Active;
  TQuery.SQL.Clear;
  TQuery.SQL.Add('');
  TQuery.Active := true;

  TQuery.First;
  total := 0;

  while not TQuery.Eof do
  begin
    total := total+FQuery.FieldByName().AsCurrency;
    TQuery.Next;
  end;

  value.Text := formatFloat('R$ ###,##0.00', total);

end;

function TEntityCaixa.calcularParcelasOS(value: TEdit): Currency;
begin

end;

function TEntityCaixa.calcularParcelasVendas(value: TEdit): Currency;
begin

end;

function TEntityCaixa.calcularRetiradas(value: TEdit): Currency;
begin

end;

constructor TEntityCaixa.create;
begin

  FQuery := TFDQuery.Create(nil);
  FQuery.Connection := DataModule1.Conexao;
  FQuery.Active := false;
  FQuery.SQL.Clear;
  FQuery.SQL.Add('select * from CAIXA_ABER_FECH order by id desc');
  FQuery.Active := true;

end;

destructor TEntityCaixa.destroy;
begin

  freeandnil(FQuery);

  inherited;
end;

function TEntityCaixa.ultimoValorDoCaixa(value: TEdit): Currency;
begin

end;

function TEntityCaixa.verificarSituacaoCaixa: string;
begin

 if FQuery.RecordCount = 0 then
 begin
   result := 'nao foi iniciado';
 end
 else if ((FQuery.FieldByName('DATA_ABERTURA').AsDateTime = date) and
  (FQuery.FieldByName('STATUS').AsString = 'aberto'))  then
  begin
    Result := 'aberto';
  end
  else if ((FQuery.FieldByName('DATA_ABERTURA').AsDateTime <> date) and
  (FQuery.FieldByName('STATUS').AsString = 'aberto'))  then
  begin
    Result := 'encerrar caixa anterior';
  end
  else if ((FQuery.FieldByName('DATA_ENCERRAMENTO').AsDateTime = date) and
  (FQuery.FieldByName('STATUS').AsString = 'fechado'))  then
  begin
    Result := 'fechado';
  end
    else if ((FQuery.FieldByName('DATA_ENCERRAMENTO').AsDateTime <> date) and
  (FQuery.FieldByName('STATUS').AsString = 'fechado'))  then
  begin
    Result := 'iniciar novo caixa';
  end


end;

end.
